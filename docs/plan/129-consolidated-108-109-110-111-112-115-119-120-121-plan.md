# Rephlo Platform: Final Single Source of Truth (SSOT) Plan

**Document ID**: 129
**Version**: 1.0
**Date**: 2025-11-10
**Status**: Authoritative Plan
**Created By**: Gemini
**Supersedes**: 108, 109, 110, 111, 112, 115, 119, 120, 121

## 1. Introduction

### 1.1. Executive Summary

This document serves as the single, final, and authoritative plan for the Rephlo Platform's next-generation monetization, administration, and profitability architecture. It merges, harmonizes, and replaces all details from the nine (9) individual source plans listed above. Any conflicts or redundancies in the original documents are resolved herein.

This plan is the official and sole reference for all development, testing, validation, and project management.

### 1.2. Consolidated Scope

This plan orchestrates the complete design, implementation, and integration of the following interconnected systems:

- **Monetization & Licensing (Plans 109, 110)**: A foundational 6-tier model, including five (5) subscription tiers (Free, Pro, Pro Max, Enterprise Pro, Enterprise Max) and one (1) "Perpetual" tier (one-time payment). This includes all logic for proration and version upgrade policies.
- **Profitability Engine (Plan 112)**: The core token-to-credit conversion system that guarantees platform gross margin by translating variable vendor API costs into stable, margin-controlled internal "credits".
- **API Access Control (Plan 108)**: The backend architecture for restricting access to specific LLM models based on a user's subscription tier, creating tangible value for higher-paying tiers.
- **Promotional System (Plan 111)**: A comprehensive system for promotional campaigns, five types of coupon codes, discount validation, and fraud detection.
- **Admin Platform Backend (Plan 119)**: A secure Role-Based Access Control (RBAC) system featuring 6 admin roles, 40+ granular permissions, an approval workflow, and a complete audit trail.
- **Admin Platform Frontend (Plans 120, 121)**: The design and implementation of a single, unified admin dashboard that integrates 14+ disparate management pages into one cohesive interface, governed by the RBAC backend.

### 1.3. High-Level Objectives

1. **Monetization (Plans 109, 110, 111)**: Launch a flexible 6-tier model to capture all market segments, enhanced by a promotional system to drive acquisition, upgrades, and retention.
2. **Profitability (Plan 112)**: Guarantee platform-wide gross margin by ensuring every API call is profitable. This is achieved by converting variable vendor costs into a stable, margin-controlled internal credit system.
3. **Access Control (Plan 108)**: Create tangible value for higher tiers by restricting access to premium, high-cost LLM models to the appropriate subscription levels.
4. **Administration (Plans 119, 120, 121)**: Drastically reduce administrative overhead and improve operational security by consolidating all admin functions into one unified dashboard, governed by a secure 6-role RBAC system.

## 2. Consolidated Architecture & Terminology

### 2.1. System Architecture Diagram

This diagram illustrates how all systems integrate. The platform is split into the Core User-Facing Platform (API) and the Admin Platform (UI/API).

```
┌──────────────────────────────────────────────────┐
│             REPHLO PLATFORM (SSOT)               │
└──────────────────────────────────────────────────┘
                 │
                 │
┌────────────────┴─────────────────────────────────┐
│              ADMIN PLATFORM (UI/API)             │
│ ┌──────────────────────────────────────────────┐ │
│ │  Unified Admin Dashboard (Plans 120, 121)    │ │
│ │  (User Mgmt, Subs, Licenses, Coupons, Analytics) │ │
│ └────────────────────┬─────────────────────────┘ │
│                      │                           │
│     ┌────────────────▼────────────────┐          │
│     │   RBAC Backend (Plan 119)       │          │
│     │ (6 Roles, 40+ Permissions, Audit) │          │
│     └─────────────────────────────────┘          │
└──────────────────────────────────────────────────┘
                 │ (Manages)
                 ▼
┌──────────────────────────────────────────────────┐
│           CORE USER-FACING PLATFORM (API)        │
│ ┌──────────────────────────────────────────────┐ │
│ │         Monetization Systems (Stripe)        │ │
│ │ ┌───────────┐ ┌───────────┐ ┌────────────┐ │ │
│ │ │ Plan 109  │ │ Plan 110  │ │ Plan 111   │ │ │
│ │ │ 5-Tier Sub│ │ Perpetual │ │ Coupons &  │ │ │
│ │ │           │ │ & Proration│ │ Campaigns  │ │ │
│ │ └───────────┘ └───────────┘ └────────────┘ │ │
│ └──────────────────────────────────────────────┘ │
│                      │ (API Request Flow)        │
│                      ▼                           │
│ ┌──────────────────────────────────────────────┐ │
│ │     Core API Gateway & Profitability Engine    │ │
│ │                                              │ │
│ │ 1. User Tier Check (from 109/110)            │ │
│ │ 2. Model Access Check (Plan 108)             │ │
│ │ 3. Token Tracking & Credit Deduction (Plan 112)│ │
│ │                                              │ │
│ └────────────────────┬─────────────────────────┘ │
│                      │ (Proxies to)              │
│ ┌────────────────────▼─────────────────────────┐ │
│ │             External LLM Vendors             │ │
│ │ (OpenAI, Anthropic, Google, etc.)            │ │
│ └──────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────┘
```

### 2.2. Authoritative Terminology (Glossary)

To ensure consistency, the following terms are defined as the authoritative standard:

- **Subscription Tiers (6)**: The complete, consolidated tier structure.

    - **Free**: $0/mo, 2,000 credits.
    - **Pro**: $19/mo, 20,000 credits.
    - **Pro Max**: $49/mo, 60,000 credits.
    - **Enterprise Pro**: $149/mo, 250,000 credits.
    - **Enterprise Max**: Custom pricing, unlimited credits.
    - **Perpetual**: $199 one-time, BYOK (Bring Your Own Key).
- **Token**: The raw, indivisible unit of work from an external LLM provider (e.g., 1 OpenAI token).
- **Credit**: The internal, abstracted unit of value consumed by the user.
- **Token-to-Credit Conversion (The "Profitability Formula")**: The authoritative formula from Plan 112:
`Credit Deduction = CEILING(Vendor Cost * Margin Multiplier)`

    - *Vendor Cost*: The actual USD cost of the tokens from the provider.
    - *Margin Multiplier*: A configurable multiplier (e.g., 1.5x) set by admins to ensure gross margin.
- **Proration**: The standard, Stripe-compatible calculation of charges or credits due when a user changes their subscription (upgrades, downgrades, or changes billing cycle) mid-cycle.
- **Admin Roles (6)**: The single set of admin roles from Plan 119.

    - **Super Admin**: Platform owner, unrestricted access.
    - **Admin**: Trusted ops lead, broad permissions (excluding system-critical).
    - **Ops**: Day-to-day subscription and license management.
    - **Support**: Customer support, read-mostly access, limited credit grants.
    - **Analyst**: Business intelligence, read-only analytics, PII masked.
    - **Auditor**: Compliance and audit trail review (read-only logs).
- **BYOK (Bring Your Own Key)**: A mode, primarily for Perpetual users, where the user provides their own LLM API key and pays the vendor directly. The platform tracks usage but does not deduct credits.
- **MRR (Monthly Recurring Revenue)**: Predictable monthly revenue from subscriptions.
- **ARR (Annual Recurring Revenue)**: MRR × 12, or annual subscription revenue.
- **LTV (Lifetime Value)**: Total revenue from a customer over their lifetime.
- **CAC (Customer Acquisition Cost)**: Total marketing/sales cost ÷ new customers acquired.
- **Dunning**: The automated process to recover failed payments.

## 3. System 1: Monetization & Licensing (Plans 109 & 110)

This system defines the user-facing products, pricing, and rules for subscription management and one-time licenses.

### 3.1. Official 6-Tier Model & Pricing

The platform will operate on a 6-tier model, superseding the 5-tier model from Plan 109.

| **Tier** | **Type** | **Price** | **Credits/Month** | **BYOK** | **Major Upgrades** | **Target Audience** |
| --- | --- | --- | --- | --- | --- | --- |
| **Free** | Subscription | $0/mo | 2,000 | ❌ | Included | Trial users, students |
| **Perpetual** | One-time | \*\*$199\*\* | None (BYOK) | ✅ | Paid upgrade ($99) | Privacy-focused users, BYOK power users |
| **Pro** | Subscription | $19/mo | 20,000 | ❌ | Included | Professionals, freelancers |
| **Pro Max** | Subscription | $49/mo | 60,000 | Optional | Included | Power users, small teams |
| **Enterprise Pro** | Subscription | $149/mo | 250,000 | Optional | Included | SMB teams, departments |
| **Enterprise Max** | Subscription | Custom | Unlimited | Optional | Included | Large enterprises, high-touch sales |

**Annual Discount:** A 17% discount (approx. 2 months free) will be offered for annual commitments on all subscription tiers (Pro, Pro Max, Enterprise Pro).

### 3.2. Tier Feature Matrix

| **Feature** | **Free** | **Perpetual** | **Pro** | **Pro Max** | **Enterprise Pro** | **Enterprise Max** |
| --- | --- | --- | --- | --- | --- | --- |
| **Licensing** | Subscription | One-time | Subscription | Subscription | Subscription | Subscription |
| **Price** | $0/mo | $199 once | $19/mo | $49/mo | $149/mo | Custom |
| **Cloud Credits** | 2,000/mo | None | 20,000/mo | 60,000/mo | 250,000/mo | Unlimited |
| **BYOK Mode** | ❌ | ✅ Always | ❌ | ✅ Add-on | ✅ Add-on | ✅ Add-on |
| **Model Access** | Free-tier only | All (via BYOK) | Pro-tier | All | All | All + Beta |
| **Command Templates** | 5 max | Unlimited | Unlimited | Unlimited | Unlimited | Unlimited |
| **Workspaces** | 1 | Unlimited | 5 | Unlimited | Unlimited | Unlimited |
| **Offline Mode (Ollama)** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **Support** | Community | Email (72hr) | Email (48hr) | Email + Chat (24hr) | Phone (12hr) | Dedicated (4hr) |
| **Minor Updates (v1.x)** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **Major Updates (v2.0)** | ✅ | ❌ (pay $99) | ✅ | ✅ | ✅ | ✅ |
| **Team Collaboration** | ❌ | ❌ | ❌ | Up to 3 | Unlimited | Unlimited |
| **Usage Analytics** | Basic | Local only | Cloud dashboard | Cloud + Export | Cloud + Custom | Custom |
| **SSO/SAML** | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ |
| **Uptime SLA** | None | None | None | None | 99.5% | 99.95% |

### 3.3. Perpetual Plan & Versioning

- **Concept**: A one-time payment of $199 grants a perpetual license to the *current major version* (e.g., v1.x.x) of the software.
- **Inclusions**: All core features, BYOK for all providers, unlimited local usage (Ollama), and all minor/patch updates (e.g., v1.1, v1.2) for that major version.
- **Exclusions**: Cloud credits, team collaboration features, and major version upgrades (e.g., v1.x to v2.0).
- **Major Version Upgrade**: When v2.0 is released, Perpetual v1 users must pay a **$99 upgrade fee** to get the v2.0 perpetual license. They may also choose to stay on v1.x (which enters maintenance mode) or switch to a subscription.
- **Lifecycle**: The previous major version (e.g., v1.x) will enter a 12-month "Maintenance Mode" (security patches only) after the new major version (v2.0) is released. After 12 months, v1.x is End-of-Life (EOL).

### 3.4. Proration Logic

Proration calculations are mandatory for all mid-cycle subscription changes to ensure fair billing. The standard, Stripe-compatible formula will be used.

**Formula**:

```
Unused Credit = (Days Remaining / Days in Period) * Current Price
New Cost = (Days Remaining / Days in Period) * New Price
Proration Amount = New Cost - Unused Credit
```

**Example: Upgrade (Pro -&gt; Pro Max)**

- **Scenario**: User on Pro Monthly ($19/mo), billing cycle Nov 1 - Nov 30 (30 days). Upgrades on Nov 15 (15 days remaining).
- **Unused Pro Credit**: (15 / 30) \* $19 = $9.50
- **New Pro Max Cost**: (15 / 30) \* $49 = $24.50
- **Charge Today**: $24.50 (New Cost) - $9.50 (Unused Credit) = \*\*$15.00\*\*
- **Next Bill**: $49.00 on Dec 1.

**Example: Downgrade (Pro Max -&gt; Pro)**

- **Scenario**: User on Pro Max Monthly ($49/mo), billing cycle Nov 1 - Nov 30. Downgrades on Nov 10 (20 days remaining).
- **Unused Pro Max Credit**: (20 / 30) \* $49 = $32.67
- **New Pro Cost**: (20 / 30) \* $19 = $12.67
- **Credit to User**: $12.67 (New Cost) - $32.67 (Unused Credit) = -$20.00
- **Action**: A $20.00 credit is applied to the user's account. Their next bill on Dec 1 ($19.00) will be free, with $1.00 credit carrying over.

### 3.5. Migration Paths

- **Perpetual -&gt; Subscription**: A user with a Perpetual license can switch to a subscription. If they purchased the license within the last 12 months, they will receive a **$50 migration credit** applied to their new subscription. Their Perpetual license becomes "inactive" but can be reactivated if the subscription is cancelled.
- **Subscription -&gt; Perpetual**: A user on a subscription (e.g., Pro Annual) can switch to Perpetual. They will be offered a choice:

    1. **Prorated Refund**: Receive a prorated refund for unused time on their subscription (minus a processing fee) and pay the full $199 for the license.
    2. **Loyalty Discount**: Forfeit the refund and receive a 30% discount on the $199 license, paying $139.

### 3.6. Dunning (Failed Payments)

A 4-step dunning process will be implemented for failed subscription payments:

- **Day 0**: Payment fails. Retry #1. Send "Payment Failed" email.
- **Day 3**: Retry #2. Send reminder email.
- **Day 7**: Retry #3. Send "Subscription at Risk" warning.
- **Day 14**: Final Retry. If fails, suspend subscription and send "Subscription Suspended" notification.
- **Day 21**: Cancel subscription.

## 4. System 2: Profitability Engine (Plan 112)

This system is the core financial engine ensuring every API call is profitable. It decouples the *cost* of tokens from the *price* of credits.

### 4.1. The "Profitability Formula"

All credit deductions are non-negotiable and follow this formula:

**`Credit Deduction = CEILING(Vendor Cost * Margin Multiplier)`**

- **Vendor Cost**: The actual, real-time USD cost of the tokens from the provider (e.g., `(input_tokens * input_price) + (output_tokens * output_price)`).
- **Margin Multiplier**: A configurable multiplier set by admins to ensure gross margin. This is the primary lever for profitability.
- **CEILING()**: The result is always rounded *up* to the nearest whole credit to prevent fractional deductions and ensure we never underbill.

#### 4.1.1. Credit-to-USD Conversion Rate

**Standard Conversion**: **1 credit = $0.01 USD**

This conversion rate is applied after the margin multiplier calculation to translate USD costs into credit deductions:

1. Calculate margin-adjusted cost: `Vendor Cost * Margin Multiplier`
2. Convert to credits: `(Margin-Adjusted Cost / 0.01)`
3. Round up: `CEILING(credits)`

**Example Calculation**:
- Vendor Cost: $0.0045 (e.g., 500 tokens at $0.009/1k tokens)
- Margin Multiplier: 1.5x (Pro tier)
- Margin-Adjusted Cost: $0.0045 * 1.5 = $0.00675
- Credits (before ceiling): $0.00675 / $0.01 = 0.675 credits
- **Final Credit Deduction**: CEILING(0.675) = **1 credit**

This 1:100 ratio (1 credit = 1 cent) provides:
- Simple mental math for users ($19/mo Pro = 2,000 cents = 20,000 credits)
- Clean integer arithmetic in the database (no floating point precision issues)
- Easy pricing adjustments at the tier level without changing the conversion rate

### 4.2. Margin Strategy by Tier

The `Margin Multiplier` will be set per-tier to balance user value with profitability. *Gross Margin = (Multiplier - 1.0) / Multiplier*

| **Tier** | **Margin Multiplier** | **Target Gross Margin** | **Rationale** |
| --- | --- | --- | --- |
| **Free** | 2.0x | 50% | Aggressive margin to protect against abuse and offset $0 revenue. |
| **Pro** | 1.5x | 33% | Balanced margin for the mass market. |
| **Pro Max** | 1.2x | 17% | Lower margin to encourage high-volume usage and upgrades. |
| **Enterprise Pro** | 1.1x | 9% | Low margin, offset by high subscription price and high volume. |
| **Enterprise Max** | 1.05x | ~5% | Minimal margin, high-touch sales with custom pricing. |

### 4.3. Token & Credit Tracking

- **Token Tracking**: The system will intercept the API response from all vendors (OpenAI, Anthropic, etc.) to capture the exact `prompt_tokens` and `completion_tokens` from the `usage` object.
- **Vendor Cost Calculation**: A service will look up the active vendor pricing from the `model_provider_pricing` table and calculate the `vendorCost` in USD (e.g., `(500 tokens * $0.005 / 1000) = $0.0025`).
- **Multiplier Lookup**: The system will fetch the user's tier and apply the appropriate `margin_multiplier` from the `pricing_config` table.
- **Atomic Credit Deduction**: The final `Credit Deduction` will be calculated and removed from the user's `user_credit_balance` table in an atomic database transaction to prevent race conditions.
- **Ledgers**: All transactions are recorded immutably in `token_usage_ledger` and `credit_deduction_ledger` for analytics and auditing.

### 4.4. Edge Case: Streaming Completions

For streaming responses, the final token count is unknown until the stream ends.

1. **Pre-check**: An *estimated* cost (based on input tokens + a buffer) is calculated. If the user's balance is insufficient, the request is blocked *before* starting.
2. **Accumulation**: As stream chunks arrive, token counts are accumulated.
3. **Final Deduction**: When the stream closes, the *final* total token count is used to calculate the *actual* `vendorCost` and `Credit Deduction`, which is then deducted atomically.

## 5. System 3: API Access Control (Plan 108)

This system provides the tangible value for higher tiers by restricting access to specific LLM models.

### 5.1. Requirements

- **P0 (Critical)**: Backend must enforce tier restrictions on inference endpoints.
- **P1 (High)**: Admin UI must exist for admins to configure model-tier assignments.
- **P2 (Medium)**: Access logic must be consistent, cached, and handle expired subscriptions gracefully (downgrade to Free tier).

### 5.2. Architecture & Logic

1. **DB Schema Update**: The `Model` table (in `schema.prisma`) will be extended with:

    - `requiredTier`: `SubscriptionTier` (e.g., `pro`)
    - `tierRestrictionMode`: `String` (e.g., `"minimum"`, `"exact"`, `"whitelist"`)
    - `allowedTiers`: `SubscriptionTier[]` (e.g., `[pro, enterprise_pro]`)
2. **Tier Access Logic**: A central `checkTierAccess(model, userTier)` function will enforce the rules:

    - **Mode "minimum" (default)**: `userTier >= requiredTier`. (e.g., if `requiredTier` is `pro`, then `pro`, `pro_max`, etc. are allowed).
    - **Mode "exact"**: `userTier == requiredTier`.
    - **Mode "whitelist"**: `allowedTiers.includes(userTier)`.
3. **API Enforcement**:

    - All inference controllers (e.g., `chatCompletion`) will first fetch the user's tier and the requested model's access rules.
    - The `checkTierAccess()` function is called.
    - If `allowed: false`, the API immediately returns a 403 "Model Access Restricted" error.
4. **Error Response**: The 403 error body will be standardized:

    ```
    {
      "status": "error",
      "code": "model_access_restricted",
      "message": "Model access restricted. This model requires the 'pro' tier or higher. Please upgrade.",
      "details": {
        "model_id": "gpt-4o",
        "user_tier": "free",
        "required_tier": "pro",
        "upgrade_url": "/subscriptions/upgrade"
      }
    }
    ```

## 6. System 4: Promotional System (Plan 111)

This system enables strategic marketing campaigns via coupons and discounts, fully integrated with the monetization and proration systems.

### 6.1. Coupon Types (5 Types)

1. **Percentage-Based**: "25% off your first 3 months."
2. **Fixed-Amount**: "$10 off your first purchase."
3. **Tier-Specific Upgrade**: "50% off when you upgrade from Pro to Pro Max."
4. **Subscription Duration**: "Buy 12 months, get 1 month free."
5. **BYOK Migration (Perpetual)**: "60% off the Perpetual Plan license."

### 6.2. Campaign Management

- **Campaigns**: Admins can create campaigns (e.g., "Black Friday 2025") that group multiple coupon codes.
- **Triggers**: Campaigns can be time-based (holidays), behavioral (trial expiration, high usage), or event-based (product launch).
- **Budgeting**: Campaigns can have a `budget_cap` to automatically disable associated coupons once the total discount spend is met.

### 6.3. Validation Logic & Rules

A 12-step algorithm will validate every coupon application:

1. Coupon exists in `coupon` table?
2. Coupon `is_active`?
3. Within `valid_from` and `valid_until` date range?
4. `applicable_tiers` includes the user's target tier?
5. `tier_specific` rules match (e.g., `current_tier` is `pro`, `target_tier` is `pro_max`)?
6. `applicable_billing_cycles` includes the user's choice (monthly/annual)?
7. User's `max_per_customer` limit (e.g., 1) not exceeded?
8. Global `max_discount_applications` limit (e.g., 1000 total) not exceeded?
9. Campaign `budget_cap` (if any) not exceeded?
10. Custom rules from `coupon_validation_rule` pass (e.g., min account age, geo-location)?
11. Fraud signal check (see below).
12. If all pass, calculate and return the discount amount.

### 6.4. Fraud Detection

The system will check for fraud signals on every redemption, flagging suspicious activity for admin review:

- **Velocity Abuse**: Multiple redemptions from the same `user_id` or `ip_address` in a short period.
- **Stacking**: Stacking high-value coupons.
- **Bot Patterns**: Bot-like user agent or device fingerprint.
- **Duplicate Devices**: Same `device_fingerprint` used across many different user accounts.

### 6.5. Checkout & Proration Integration

- **New Subscriptions**: The coupon discount is applied to the base price before the Stripe charge is created.
- **Mid-Cycle Upgrades**: The coupon discount is applied to the *prorated charge*.

    - *Example*: A user's prorated upgrade charge is $15. A 20% off coupon ("UPGRADE20") is applied.
    - *Calculation*: $15.00 \* 0.20 = $3.00 discount.
    - *Final Charge*: $15.00 - $3.00 = \*\*$12.00\*\*.

## 7. System 5: Admin Platform Backend - RBAC (Plan 119)

This system provides the secure, granular backend for the entire Admin Platform, defining who can do what.

### 7.1. Core Entities & Logic

- **Role**: Defines 6 system roles (`super_admin`, `admin`, `ops`, `support`, `analyst`, `auditor`).
- **Permission**: Defines 40+ atomic permissions (e.aws, `subscriptions.view`, `subscriptions.refund`, `users.ban`).
- **UserRoleAssignment**: Links a User to a Role.
- **Permission Logic**: A user's effective permissions are the *union* of all permissions from all their assigned roles.
- **Permission Override**: An admin can grant a *temporary* (e.g., "grant `licenses.revoke` for 24 hours") or *permanent* permission override to a specific user, which is logged in the audit trail.

### 7.2. Official 6-Role Hierarchy & Key Permissions

| **Role** | **Hierarchy** | **Key Responsibilities & Permissions** |
| --- | --- | --- |
| **Super Admin** | 1 (Highest) | Platform owner. Unrestricted access. Can manage roles, assign any role, and approve critical operations. |
| **Admin** | 2 | Trusted ops lead. Can manage users, subscriptions, and campaigns. Can assign roles *below* Admin. Needs approval for critical ops (refunds, bans). |
| **Ops** | 3 | Day-to-day management. Can edit subscriptions, grant credits (up to $100), and temporarily suspend users. **Cannot** issue refunds or ban users. |
| **Support** | 4 | Read-mostly access. Can view user/subscription details. Can grant small "goodwill" credits (up to $50). **Cannot** modify subscriptions or suspend users. |
| **Analyst** | 5 | Read-only analytics. Can view all dashboards and export data. All PII (names, emails) is **masked**. **Cannot** modify any data. |
| **Auditor** | 6 (Lowest) | Read-only compliance. Can view all audit logs (admin actions, role changes) and financial records. **Cannot** modify data or view real-time user info. |

### 7.3. Permission Permission Matrix (Summary)

| **Permission** | **Super Admin** | **Admin** | **Ops** | **Support** | **Analyst** | **Auditor** |
| --- | --- | --- | --- | --- | --- | --- |
| `subscriptions.view` | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ (audit) |
| `subscriptions.edit` | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| `subscriptions.refund` | ✅ | ✅ (approval) | ❌ | ❌ | ❌ | ❌ |
| `credits.grant` | ✅ | ✅ ($500) | ✅ ($100) | ✅ ($50) | ❌ | ❌ |
| `credits.deduct` | ✅ | ✅ (approval) | ❌ | ❌ | ❌ | ❌ |
| `users.view` | ✅ | ✅ | ✅ | ✅ | ✅ (masked) | ✅ (audit) |
| `users.suspend` | ✅ | ✅ | ✅ (30 days) | ❌ | ❌ | ❌ |
| `users.ban` | ✅ | ✅ (approval) | ❌ | ❌ | ❌ | ❌ |
| `users.impersonate` | ✅ (MFA) | ❌ | ❌ | ❌ | ❌ | ❌ |
| `roles.assign` | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| `roles.view_audit_log` | ✅ | ✅ (own) | ❌ | ❌ | ❌ | ✅ (all) |
| `analytics.view_revenue` | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ |
| `analytics.export_data` | ✅ | ✅ | ❌ | ❌ | ✅ (anon) | ❌ |

### 7.4. Security & Audit Measures

- **Audit Logging**: Every sensitive action (role change, credit grant, user suspension, etc.) is immutably recorded in `RoleChangeLog` and `AdminAuditLog`, capturing the *admin, target, action, before/after values, and IP address*.
- **MFA Enforcement**: Critical operations (e.g., `users.delete`, `users.impersonate`) require a second factor (TOTP or Hardware Key). Super Admins require hardware MFA.
- **Approval Workflow**: High-risk actions (e.g., `subscriptions.refund`, `users.ban`) requested by an "Admin" role enter a "pending" state in the `ApprovalRequest` table, requiring a "Super Admin" to approve them.
- **IP Whitelisting**: Access for the "Super Admin" role is restricted to a list of approved IP addresses/CIDR ranges stored in the `IPWhitelist` table.
- **Session Invalidation**: When a user's roles or permissions are changed, all their active sessions are immediately invalidated, forcing them to log in again.

## 8. System 6: Admin Platform Frontend (Plans 120 & 121)

This system provides the single, unified web interface for all administrative tasks, integrating all backend systems.

### 8.1. UI/UX Guidelines & Gaps Addressed

This UI solves the 5 critical gaps identified in Plan 120 (fragmented user data, no cross-plan analytics, missing navigation, duplicate components, no global search).

- **Theme**: All pages **must** use the **Deep Navy** theme (from Plans 109/110).
- **Pagination**: All data tables **must** use **1-indexed pagination** (page 1 is the first page) for consistency.
- **Critical Fixes**: The implementation **must** refactor the admin pages from Plan 111, replacing their Gray theme and 0-indexed pagination to conform to the new standard.

### 8.2. Unified Component Library

A shared component library will be built in `frontend/src/components/admin/` to eliminate duplication.

- **Layout**: `AdminLayout.tsx`, `AdminSidebar.tsx`, `AdminHeader.tsx` (with breadcrumbs)
- **Data**: `AdminStatsGrid.tsx`, `AdminDataTable.tsx`, `AdminFilterPanel.tsx`, `AdminPagination.tsx` (1-indexed)
- **Forms**: `ConfirmationModal.tsx`, `FormModal.tsx`
- **Badges**: `TierBadge.tsx` (Pro, Pro Max, etc.), `StatusBadge.tsx` (Active, Suspended, etc.)
- **Utility**: `EmptyState.tsx`, `LoadingState.tsx`, `ErrorBoundary.tsx`

### 8.3. Consolidated Page Designs

#### 1. Admin Dashboard (`/admin`)

- **KPI Grid**: 4 top-level KPIs aggregating cross-plan data (Total Revenue, Active Users, Credits Consumed, Coupon Redemptions).
- **Charts**: Revenue Mix (Subscription vs. Perpetual), User Growth, Credit Usage by Model.
- **Recent Activity Feed**: A combined feed of recent subscriptions, license sales, and coupon redemptions.

#### 2. Unified User Detail View (`/admin/users/:id`)

This page replaces 4+ fragmented pages and presents all user data in one tabbed interface:

- **Tab 1: Overview**: User profile, current subscription, credit balance, quick actions (suspend, adjust credits).
- **Tab 2: Subscriptions**: Current subscription details, subscription history, proration events.
- **Tab 3: Licenses**: Perpetual licenses owned, device activations, upgrade history.
- **Tab 4: Credits**: Credit balance, allocation history, deduction ledger, usage by model.
- **Tab 5: Coupons**: Coupon redemption history, fraud flags.
- **Tab 6: Payments**: Stripe invoice history, link to Stripe customer dashboard.
- **Tab 7: Activity**: Combined timeline of all user actions.

#### 3. Revenue Analytics Dashboard (`/admin/analytics/revenue`)

- **KPI Grid**: Total Revenue (MRR + Perpetual), MRR, Perpetual Revenue, ARPU, Coupon Discount Value.
- **Charts**: Revenue Mix (Subscription vs. Perpetual), Revenue Trend (Total, Sub, Perp lines), Conversion Funnel, Credit Usage by Model.
- **Coupon ROI Analysis Table**: ROI % (Revenue / Discount) for each campaign.

#### 4. RBAC Management Pages (`/admin/roles/*`)

- **Roles List**: View all 6 system roles and any custom roles.
- **Role Detail/Edit**: View/edit the 40+ permissions for a specific role (Super Admin only).
- **User Assignment**: Assign roles to users, add/revoke permission overrides with expirations.
- **Audit Log Viewer**: A searchable, filterable view of the `RoleChangeLog` and `AdminAuditLog`.

## 9. Consolidated Database Schema

This section merges all new tables and modifications from all plans into a single `schema.prisma` definition.

```
// --- User & Core Models (Existing, modified) ---

model User {
  id    String @id @default(uuid())
  email String @unique
  name  String?
  // ... other existing fields

  // [Plan 109] Status & LTV
  status           UserStatus @default(active)
  suspendedUntil   DateTime?  @map("suspended_until")
  bannedAt         DateTime?  @map("banned_at")
  deletedAt        DateTime?  @map("deleted_at")
  lifetimeValue    Int        @default(0) @map("lifetime_value") // In cents

  // [Plan 110] Perpetual License Flag
  hasActivePerpetualLicense Boolean @default(false) @map("has_active_perpetual_license")

  // --- RELATIONS ---
  subscriptions    Subscription[]
  creditBalance    UserCreditBalance?   @relation("UserCreditBalance")
  perpetualLicenses PerpetualLicense[]
  prorationEvents  ProrationEvent[]
  couponRedemptions CouponRedemption[]
  creditAllocations CreditAllocation[]
  creditDeductions  CreditDeductionLedger[]
  tokenUsage       TokenUsageLedger[]

  // [Plan 119] RBAC Relations
  userRoleAssignments  UserRoleAssignment[] @relation("UserRoleAssignments")
  assignedRoles        UserRoleAssignment[] @relation("AssignedByUser")
  targetUserChangeLogs RoleChangeLog[]      @relation("TargetUserChangeLogs")
  adminUserChangeLogs  RoleChangeLog[]      @relation("AdminUserChangeLogs")
  approvalRequests     ApprovalRequest[]    @relation("ApprovalRequester")
  approvalReviews      ApprovalRequest[]    @relation("ApprovalReviewer")
  ipWhitelists         IPWhitelist[]        @relation("UserIPWhitelist")
  adminAuditLogs       AdminAuditLog[]      @relation("AdminActions")
  suspensions          UserSuspension[]     @relation("UserSuspensions")
  suspendedUsers       UserSuspension[]     @relation("SuspenderActions")
  liftedSuspensions    UserSuspension[]     @relation("LifterActions")
}

model Model {
  id          String  @id @db.VarChar(100)
  name        String
  provider    String
  // ... other existing fields

  // [Plan 108] Model Tier Access Control
  requiredTier        SubscriptionTier   @default(free) @map("required_tier")
  tierRestrictionMode String             @default("minimum") @map("tier_restriction_mode") @db.VarChar(20) // "minimum", "exact", "whitelist"
  allowedTiers        SubscriptionTier[] @default([free, pro, pro_max, enterprise_pro, enterprise_max]) @map("allowed_tiers")

  @@index([requiredTier])
  @@index([isAvailable, requiredTier])
}

// --- Enums ---

enum SubscriptionTier {
  free
  pro
  pro_max
  enterprise_pro
  enterprise_max
  perpetual // [Plan 110] Add perpetual as a "tier"
}

enum SubscriptionStatus {
  active
  cancelled
  expired
  suspended
  trial
  past_due
}

enum UserStatus {
  active
  suspended
  banned
  deleted
}

enum LicenseStatus { // [Plan 110]
  active
  inactive // Subscription took over
  expired  // v1.x EOL reached
  suspended
  revoked
}

enum ProrationEventType { // [Plan 110]
  upgrade
  downgrade
  interval_change
  migration
  cancellation
}

enum CouponType { // [Plan 111]
  percentage
  fixed_amount
  tier_specific
  duration_bonus
  perpetual_migration
}

enum RoleChangeAction { // [Plan 119]
  role_assigned
  role_revoked
  role_changed
  permission_override_granted
  permission_override_revoked
  permission_override_expired
}

// --- System 1: Monetization (Plans 109 & 110) ---

// Note: The subscription system is implemented as a split architecture for better separation of concerns:
// - SubscriptionMonetization: User's active subscription instance
// - SubscriptionTierConfig: Tier definitions and pricing (admin-configurable)

model SubscriptionMonetization {
  id                 String    @id @default(uuid()) @db.Uuid
  userId             String    @map("user_id") @db.Uuid

  // Subscription Details
  tier               String    @db.VarChar(50) // 'free', 'pro', 'pro_max', 'enterprise_pro', 'enterprise_max', 'perpetual'
  billingCycle       String    @map("billing_cycle") @db.VarChar(20) // 'monthly', 'annual', 'lifetime'
  status             String    @db.VarChar(20) // 'trial', 'active', 'past_due', 'cancelled', 'expired'

  // Pricing
  basePriceUsd            Decimal @map("base_price_usd") @db.Decimal(10, 2)
  monthlyCreditAllocation Int     @map("monthly_credit_allocation")

  // Stripe Integration
  stripeCustomerId     String?  @unique @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId String?  @unique @map("stripe_subscription_id") @db.VarChar(255)

  // Billing Period
  currentPeriodStart DateTime  @map("current_period_start")
  currentPeriodEnd   DateTime  @map("current_period_end")
  trialEndsAt        DateTime? @map("trial_ends_at")

  // Cancellation Tracking
  cancelledAt        DateTime? @map("cancelled_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user                User                 @relation("UserSubscriptionMonetization", fields: [userId], references: [id], onDelete: Cascade)
  creditAllocations   CreditAllocation[]
  billingInvoices     BillingInvoice[]
  paymentTransactions PaymentTransaction[]
  dunningAttempts     DunningAttempt[]
  prorationEvents     ProrationEvent[]
  couponRedemptions   CouponRedemption[]

  @@index([userId])
  @@index([status])
  @@index([tier])
  @@index([currentPeriodEnd])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("subscription_monetization")
}

model SubscriptionTierConfig { // [Plan 109] Defines tier pricing and features (admin-configurable)
  id String @id @default(uuid()) @db.Uuid

  // Tier Identification
  tierName String @unique @map("tier_name") @db.VarChar(50) // 'free', 'pro', 'pro_max', etc.

  // Pricing
  monthlyPriceUsd Decimal @map("monthly_price_usd") @db.Decimal(10, 2)
  annualPriceUsd  Decimal @map("annual_price_usd") @db.Decimal(10, 2)

  // Credit Allocation
  monthlyCreditAllocation Int @map("monthly_credit_allocation")
  maxCreditRollover       Int @map("max_credit_rollover") // Maximum credits that can roll over

  // Features (JSONB for flexibility)
  features Json @default("{}")
  // Example: {"apiAccess": true, "prioritySupport": true, "maxProjects": 10}

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("subscription_tier_config")
}

model PerpetualLicense { // [Plan 110]
  id                   String        @id @default(uuid()) @db.Uuid
  userId               String        @map("user_id") @db.Uuid
  licenseKey           String        @unique @map("license_key") @db.VarChar(50)
  status               LicenseStatus @default(pending)

  // Purchase Details
  purchasePriceUsd     Decimal       @map("purchase_price_usd") @db.Decimal(10, 2) // USD amount (better precision than cents)
  purchasedVersion     String        @map("purchased_version") @db.VarChar(50) // SemVer: "1.0.0", "2.0.0"

  // Version Eligibility (SemVer string format for flexibility)
  eligibleUntilVersion String        @map("eligible_until_version") @db.VarChar(50) // e.g., "1.99.99" = all v1.x releases

  // Activation Limits
  maxActivations       Int           @default(3) @map("max_activations")
  currentActivations   Int           @default(0) @map("current_activations")

  // Dates
  purchasedAt          DateTime      @default(now()) @map("purchased_at")
  activatedAt          DateTime?     @map("activated_at")
  expiresAt            DateTime?     @map("expires_at")
  suspendedAt          DateTime?     @map("suspended_at")
  revokedAt            DateTime?     @map("revoked_at")

  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  activations LicenseActivation[]

  @@index([userId])
  @@index([status])
  @@index([licenseKey])
  @@map("perpetual_licenses")
}

model LicenseActivation { // [Plan 110]
  id                String    @id @default(uuid()) @db.Uuid
  licenseId         String    @map("license_id") @db.Uuid
  machineId         String    @map("machine_id")
  machineName       String?
  appVersion        String
  activatedAt       DateTime  @default(now())
  lastSeenAt        DateTime  @updatedAt
  deactivatedAt     DateTime?
  
  license PerpetualLicense @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@index([licenseId])
  @@index([machineId])
  @@map("license_activations")
}

model ProrationEvent { // [Plan 110]
  id                   String             @id @default(uuid()) @db.Uuid
  userId               String             @map("user_id") @db.Uuid
  subscriptionId       String             @map("subscription_id") @db.Uuid
  eventType            ProrationEventType
  fromTier             SubscriptionTier?
  toTier               SubscriptionTier?
  unusedCreditCents    Int                @map("unused_credit_cents")
  newCostCents         Int                @map("new_cost_cents")
  prorationAmountCents Int                @map("proration_amount_cents") // charge or credit
  changeDate           DateTime           @map("change_date")
  
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([userId])
  @@index([subscriptionId])
  @@map("proration_events")
}

// --- System 2: Profitability (Plan 112) ---

model UserCreditBalance {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  amount    Int      @default(0) // Current balance
  updatedAt DateTime @updatedAt
  
  user User @relation("UserCreditBalance", fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_credit_balance")
}

model CreditAllocation { // Tracks *additions* to balance
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  amount      Int      // Positive number
  source      String   // "subscription", "bonus", "coupon", "refund"
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("credit_allocation")
}

model CreditDeductionLedger { // Tracks *subtractions* from balance
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  amount          Int      // Positive number (how much was deducted)
  balanceBefore   Int
  balanceAfter    Int
  reason          String   // "api_completion", "manual_adjustment"
  processedAt     DateTime @default(now())
  
  tokenUsageId    String?  @unique @map("token_usage_id")
  tokenUsage      TokenUsageLedger? @relation(fields: [tokenUsageId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("credit_deduction_ledger")
}

model TokenUsageLedger { // Tracks raw token usage
  id                 String    @id @default(uuid()) @db.Uuid
  userId             String    @map("user_id") @db.Uuid
  modelId            String    @map("model_id")
  provider           String
  inputTokens        Int       @map("input_tokens")
  outputTokens       Int       @map("output_tokens")
  
  vendorCost         Decimal   @map("vendor_cost") @db.Decimal(10, 8) // Actual USD cost
  marginMultiplier   Decimal   @map("margin_multiplier") @db.Decimal(4, 2) // e.g., 1.50
  creditValueUsd     Decimal   @map("credit_value_usd") @db.Decimal(10, 8) // cost * multiplier
  creditsDeducted    Int       @map("credits_deducted") // The final CEILING() result
  
  requestStartedAt   DateTime  @map("request_started_at")
  requestCompletedAt DateTime  @map("request_completed_at")
  
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  deduction          CreditDeductionLedger?

  @@index([userId])
  @@index([modelId])
  @@map("token_usage_ledger")
}

model ModelProviderPricing { // [Plan 112] Stores vendor costs
  id                String   @id @default(uuid()) @db.Uuid
  provider          String
  modelName         String   @map("model_name")
  inputPricePer1k   Decimal  @map("input_price_per_1k") @db.Decimal(10, 8)
  outputPricePer1k  Decimal  @map("output_price_per_1k") @db.Decimal(10, 8)
  effectiveFrom     DateTime @map("effective_from")
  isActive          Boolean  @default(true)
  
  @@unique([provider, modelName, effectiveFrom])
  @@map("model_provider_pricing")
}

model PricingConfig { // [Plan 112] Stores margin multipliers
  id                String   @id @default(uuid()) @db.Uuid
  scopeType         String   // "tier", "provider", "model", "combination"
  subscriptionTier  SubscriptionTier?
  provider          String?
  modelId           String?
  marginMultiplier  Decimal  @map("margin_multiplier") @db.Decimal(4T, 2) // e.g., 1.50
  effectiveFrom     DateTime @map("effective_from")
  isActive          Boolean  @default(true)
  
  @@map("pricing_config")
}

// --- System 4: Promotional System (Plan 111) ---

model Campaign {
  id            String    @id @default(uuid()) @db.Uuid
  name          String
  type          String    // "holiday", "marketing", "behavioral"
  startsAt      DateTime  @map("starts_at")
  endsAt        DateTime  @map("ends_at")
  budgetCap     Decimal?  @map("budget_cap") @db.Decimal(12, 2)
  currentSpend  Decimal   @default(0) @map("current_spend") @db.Decimal(12, 2)
  status        String    @default("planning") // "planning", "active", "ended"
  
  coupons Coupon[]
  
  @@map("campaign")
}

model Coupon {
  id                  String     @id @default(uuid()) @db.Uuid
  code                String     @unique @db.VarChar(50)
  type                CouponType
  discountPercentage  Decimal?   @db.Decimal(5, 2)
  discountAmount      Decimal?   @db.Decimal(10, 2) // In cents
  bonusDurationMonths Int?
  
  applicableTiers     Json?      // ["pro", "pro_max"]
  applicableBillingCycles Json?  // ["monthly", "annual"]
  
  maxDiscountMonths   Int?       // e.g., for "3 months"
  maxDiscountApplications Int?   // e.g., "first 500 users"
  maxPerCustomer      Int        @default(1)
  
  validFrom           DateTime   @map("valid_from")
  validUntil          DateTime   @map("valid_until")
  isActive            Boolean    @default(true)
  
  campaignId          String?    @map("campaign_id") @db.Uuid
  campaign            Campaign?  @relation(fields: [campaignId], references: [id])
  
  redemptions         CouponRedemption[]
  validationRules     CouponValidationRule[]

  @@map("coupon")
}

model CouponRedemption {
  id                  String   @id @default(uuid()) @db.Uuid
  couponId            String   @map("coupon_id") @db.Uuid
  userId              String   @map("user_id") @db.Uuid
  subscriptionId      String?  @map("subscription_id") @db.Uuid
  
  discountAppliedAmount Decimal  @map("discount_applied_amount") @db.Decimal(10, 2)
  orderValueBeforeDiscount Decimal @map("order_value_before_discount") @db.Decimal(10, 2)
  
  isFlagged           Boolean  @default(false) @map("is_flagged") // Fraud
  flagReason          String?  @map("flag_reason")
  ipAddress           String?  @map("ip_address")
  
  createdAt           DateTime @default(now())
  
  coupon       Coupon       @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])
  
  @@index([couponId])
  @@index([userId])
  @@map("coupon_redemption")
}

model CouponValidationRule {
  id        String @id @default(uuid()) @db.Uuid
  couponId  String @map("coupon_id") @db.Uuid
  ruleType  String // "min_account_age_days", "geo_location_allowed"
  ruleConfig Json
  
  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  
  @@map("coupon_validation_rule")
}

// --- System 5: Admin RBAC (Plan 119) ---

model Role {
  id                 String   @id @default(uuid()) @db.Uuid
  name               String   @unique @db.VarChar(50) // "super_admin", "ops"
  displayName        String   @map("display_name")
  description        String   @db.Text
  isSystemRole       Boolean  @default(false) @map("is_system_role")
  hierarchy          Int      @db.SmallInt // 1=super_admin, 6=auditor
  defaultPermissions Json     @map("default_permissions") // ["users.view"]
  
  userRoleAssignments UserRoleAssignment[]
  roleChangeLogs      RoleChangeLog[]      @relation("RoleChangeLogs")

  @@map("role")
}

model UserRoleAssignment {
  id                  String    @id @default(uuid()) @db.Uuid
  userId              String    @map("user_id") @db.Uuid
  roleId              String    @map("role_id") @db.Uuid
  assignedBy          String    @map("assigned_by") @db.Uuid
  assignedAt          DateTime  @default(now())
  expiresAt           DateTime? @map("expires_at")
  
  permissionOverrides Json      @default("[]") @map("permission_overrides")
  // [ { "permission": "licenses.revoke", "action": "grant", "expiresAt": "..." } ]
  
  user           User @relation("UserRoleAssignments", fields: [userId], references: [id], onDelete: Cascade)
  role           Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedByUser User @relation("AssignedByUser", fields: [assignedBy], references: [id])

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_role_assignment")
}

model RoleChangeLog {
  id            String           @id @default(uuid()) @db.Uuid
  targetUserId  String           @map("target_user_id") @db.Uuid
  changedBy     String           @map("changed_by") @db.Uuid
  action        RoleChangeAction
  oldRoleId     String?          @map("old_role_id") @db.Uuid
  newRoleId     String?          @map("new_role_id") @db.Uuid
  oldPermissions Json?           @map("old_permissions")
  newPermissions Json?           @map("new_permissions")
  reason        String?          @db.Text
  ipAddress     String?          @map("ip_address") @db.VarChar(45)
  timestamp     DateTime         @default(now())
  
  targetUser User @relation("TargetUserChangeLogs", fields: [targetUserId], references: [id])
  adminUser  User @relation("AdminUserChangeLogs", fields: [changedBy], references: [id])
  oldRole    Role? @relation("RoleChangeLogs", fields: [oldRoleId], references: [id])

  @@index([targetUserId])
  @@index([changedBy])
  @@map("role_change_log")
}

model ApprovalRequest { // [Plan 119]
  id             String    @id @default(uuid()) @db.Uuid
  requestedBy    String    @map("requested_by") @db.Uuid
  action         String    // "subscriptions.refund", "users.ban"
  targetUserId   String?   @map("target_user_id") @db.Uuid
  reason         String    @db.Text
  status         String    @default("pending") // "pending", "approved", "denied"
  reviewedBy     String?   @map("reviewed_by") @db.Uuid
  reviewedAt     DateTime? @map("reviewed_at")
  reviewNotes    String?   @map("review_notes") @db.Text
  expiresAt      DateTime  @map("expires_at") // Auto-deny after 24h
  
  requester User  @relation("ApprovalRequester", fields: [requestedBy], references: [id])
  reviewer  User? @relation("ApprovalReviewer", fields: [reviewedBy], references: [id])
  
  @@index([status])
  @@map("approval_request")
}

model IPWhitelist { // [Plan 119]
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid // Super Admin user ID
  ipAddress   String   @map("ip_address") @db.VarChar(50) // CIDR notation
  description String?
  isActive    Boolean  @default(true)
  
  user User @relation("UserIPWhitelist", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, isActive])
  @@map("ip_whitelist")
}

// --- System 6: Admin Moderation (Plan 109 & 119) ---

model AdminAuditLog { // General purpose log
  id            String   @id @default(uuid()) @db.Uuid
  adminUserId   String   @map("admin_user_id") @db.Uuid
  action        String   @db.VarChar(100)
  resourceType  String   @map("resource_type") @db.VarChar(50) // "user", "subscription"
  resourceId    String?  @map("resource_id") @db.Uuid
  previousValue Json?    @map("previous_value")
  newValue      Json?    @map("new_value")
  reason        String?  @db.Text
  ipAddress     String?  @map("ip_address") @db.VarChar(45)
  createdAt     DateTime @default(now())
  
  admin User @relation("AdminActions", fields: [adminUserId], references: [id])

  @@index([adminUserId])
  @@index([resourceType, resourceId])
  @@map("admin_audit_logs")
}

model UserSuspension {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  suspendedBy String    @map("suspended_by") @db.Uuid
  reason      String    @db.Text
  suspendedAt DateTime  @default(now())
  expiresAt   DateTime? // null = indefinite (ban)
  liftedAt    DateTime?
  liftedBy    String?   @map("lifted_by") @db.Uuid
  
  user      User  @relation("UserSuspensions", fields: [userId], references: [id], onDelete: Cascade)
  suspender User  @relation("SuspenderActions", fields: [suspendedBy], references: [id])
  lifter    User? @relation("LifterActions", fields: [liftedBy], references: [id])

  @@index([userId])
  @@map("user_suspensions")
}
```

## 10. Consolidated Implementation Plan

This plan consolidates all individual timelines (from 108, 109, 110, 111, 112, 115, 119, 121) into six (6) parallel workstreams, orchestrated over a 52-week master schedule.

### Workstream 1: Core Monetization & Profitability (Plans 109, 110, 112)

- **Objective**: Implement the 6-tier subscription/perpetual model and the token-to-credit profitability engine.
- **Weeks 1-2 (M1.1)**: **DB Schema (Part 1)**. Implement tables for `subscription`, `subscription_tier_config`, `perpetual_license`, `license_activation`, `proration_event`.
- **Weeks 3-4 (M1.1)**: **DB Schema (Part 2)**. Implement tables for `model_provider_pricing`, `pricing_config`, `token_usage_ledger`, `user_credit_balance`, `credit_allocation`, `credit_deduction_ledger`.
- **Weeks 5-8 (M1.2)**: **Core Services (Part 1)**. Build `SubscriptionManagementService` and `ProrationService`.
- **Weeks 9-12 (M1.2)**: **Core Services (Part 2)**. Build `LicenseManagementService` (incl. activation/validation) and `MigrationService`.
- **Weeks 13-16 (M1.2)**: **Core Services (Part 3)**. Build `TokenTrackingService` and `CreditDeductionService` (atomic deduction). This is the core profitability engine.
- **Weeks 17-20 (M1.3)**: **Stripe Integration**. Build Stripe webhook handlers for `invoice.payment_succeeded`, `invoice.payment_failed`, `customer.subscription.updated`, etc. Implement dunning logic.
- **Weeks 21-22 (M1.4)**: **Migration Paths**. Build and test the user flows for Subscription &lt;-&gt; Perpetual migrations.

### Workstream 2: Core API Access Control (Plan 108)

- **Objective**: Implement tier-based restrictions on LLM models.
- **Weeks 1-2 (M2.1)**: **DB Schema Update**. Add `requiredTier`, `tierRestrictionMode`, and `allowedTiers` to the `Model` table.
- **Weeks 3-4 (M2.2)**: **Service Layer**. Implement `canUserAccessModel(modelId, userTier)` logic in the `ModelService`.
- **Weeks 5-6 (M2.3)**: **API Enforcement**. Integrate the `canUserAccessModel` check into all inference endpoints (e.g., `/v1/chat/completions`) and test 403 error responses.

### Workstream 3: Promotional Systems (Plan 111)

- **Objective**: Implement the coupon and campaign system.
- **Weeks 23-24 (M3.1)**: **DB Schema**. Implement tables for `campaign`, `coupon`, `coupon_redemption`, and `coupon_validation_rule`.
- **Weeks 25-28 (M3.2)**: **Validation Service**. Build the 12-step `CouponValidationService` and fraud detection logic.
- **Weeks 29-30 (M3.3)**: **Campaign Management Service**. Build the backend service to create, manage, and track campaign budgets.
- **Weeks 31-32 (M3.4)**: **Checkout Integration**. Update the `SubscriptionManagementService` and `ProrationService` to correctly apply coupon discounts.

### Workstream 4: Admin Platform - RBAC (Plan 119)

- **Objective**: Build the backend for the 6-role admin permission system.
- **Weeks 33-34 (M4.1)**: **DB Schema**. Implement tables for `Role`, `UserRoleAssignment`, `RoleChangeLog`, `ApprovalRequest`, `IPWhitelist`, `AdminAuditLog`, `UserSuspension`.
- **Weeks 35-38 (M4.2)**: **Core Services**. Build the `PermissionService` (with `hasPermission()` logic), `RoleManagementService`, and `AuditLogService`.
- **Weeks 39-42 (M4.3)**: **Security Implementation**. Enforce MFA, session invalidation, IP whitelisting, and build the approval workflow backend.

### Workstream 5: Admin Platform - UI (Plans 120, 121)

- **Objective**: Build the single, unified frontend dashboard.
- **Weeks 33-34 (M5.1)**: **Foundation (Prep)**. Install dependencies (`@tanstack/react-query`, `zustand`), set up directory structure, providers, and router.
- **Weeks 35-38 (M5.1)**: **Foundation (Build)**. Build core `AdminLayout`, `AdminSidebar`, `AdminHeader`, and shared component library (DataTables, Badges, Modals, 1-indexed Pagination).
- **Weeks 39-40 (M5.2)**: **Dashboard Home**. Create the main `/admin` dashboard with cross-plan KPIs.
- **Weeks 41-44 (M5.3)**: **Page Integration & Harmonization**. Migrate all 14+ admin pages from 109, 110, and 111 into the new layout. **This includes fixing Plan 111's UI inconsistencies** (Gray theme -&gt; Deep Navy, 0-indexed -&gt; 1-indexed pagination).
- **Weeks 45-46 (M5.4)**: **Unified Views**. Build the new, consolidated `UserDetailUnified.tsx` and `RevenueAnalytics.tsx` pages.
- **Weeks 47-48 (M5.5)**: **RBAC Integration**. Connect the UI to the Plan 119 backend. Dynamically show/hide UI elements based on the logged-in admin's role.

### Workstream 6: Integration Testing & Deployment (Weeks 49-52)

- **Objective**: Ensure all parallel workstreams merge and function as a single, cohesive platform.
- **Weeks 49-50 (M6.1)**: **Cross-System Integration Testing**. Test complex end-to-end user stories (see Acceptance Criteria).
- **Week 51 (M6.2)**: **User Acceptance Testing (UAT)**. Conduct UAT with internal stakeholders (Support, Ops, Marketing).
- **Week 52 (M6.3)**: **Staging & Production Rollout**. Execute deployment, run data migrations, and monitor platform health.

## 11. Consolidated Testing & Acceptance Criteria

### 11.1. GIVEN/WHEN/THEN User Stories

This section provides user stories for validation, confirming that all systems are integrated correctly.

| **System(s)** | **User Story** | **Given** | **When** | **Then** |
| --- | --- | --- | --- | --- |
| **109** (Monetization) | **New Subscription** | A new user is on the "Free" tier. | They complete checkout for the "Pro" tier ($19/mo). | Their account is charged $19, their tier is updated to "Pro", and they receive 20,000 credits. |
| **108** (Model Access) | **Tier Restriction** | A "Free" tier user. | They attempt to use a "Pro" tier model (e.g., GPT-4o). | The API returns a 403 error with an "upgrade\_required" message. |
| **112** (Profitability) | **Credit Deduction** | A "Pro" tier user (with a 1.5x margin multiplier). | They make an API call that costs Rephlo $0.01 in vendor fees. | Their credit balance is deducted by **16 credits** (`CEILING($0.01 \* 1.5 / $0.00095\_PER\_CREDIT)`  assuming $19/20,000 credits). |

### 11.2. Key Success Metrics

#### Revenue & Monetization Metrics (Plans 109, 110, 111)

- **MRR Growth**: Target 20% MoM for the first 6 months.
- **ARR**: Target $1.5M by end of Year 1.
- **ARPU (Average Revenue Per User)**: Target $45/month.
- **LTV:CAC Ratio**: Target &gt; 5:1.
- **Free -&gt; Paid Conversion**: Target 8-10%.
- **Net Revenue Retention (NRR)**: Target &gt; 100%.
- **Perpetual Sales**: Target 200 licenses in Year 1 ($39,800 revenue).
- **Upgrade Conversion (v1-&gt;v2)**: Target 40% of v1 Perpetual users upgrade to v2.
- **Coupon Campaign Revenue**: Target $250k-$400k in Year 1.
- **Referral Program CAC**: Target &lt; $20.

#### Profitability Metrics (Plan 112)

- **Actual Gross Margin**: Must be within ±2% of Target Margin per tier.
- **Negative Margin Requests**: Target **0**. Any instance is a P0 bug.
- **Vendor Rate Change Alert**: System must detect and alert admins to vendor price changes &gt;10% within 24 hours.

#### Operational & Admin Metrics (Plans 119, 120, 121)

- **Admin Task Completion**: 40% faster on average with new unified UI.
- **Admin Onboarding Time**: Reduced by 50%.
- **Admin UI Lighthouse Score**: &gt;90 for Performance.
- **Admin UI Accessibility**: WCAG 2.1 AA compliant (0 critical violations).
- **RBAC Permission Checks**: `hasPermission()` function execution time &lt; 10ms.
- **Audit Log Completeness**: 100% of all critical actions (as defined in Plan 119) are logged.

## 12. Consolidated Risk Management

This section merges risks from all source plans.

| **Risk ID** | **Risk Description** | **Probability** | **Impact** | **Mitigation Strategy** |
| --- | --- | --- | --- | --- |
| **R-110.1** | **Subscription Cannibalization** | Medium | High | Price Perpetual plan high ($199, ~10mo of Pro) to target a different user segment. Exclude cloud credits and team features to make subscriptions more attractive for most users. |
| **R-110.2** | **License Piracy/Sharing** | High | High | Implement 3-device machine activation limit (`license_activation` table). Require online validation check-in at least once every 7 days. Monitor for suspicious activation patterns (e.g., &gt;5 IPs for one key). |
| **R-110.3** | **Proration Errors** | Medium | Medium | Use comprehensive unit tests for all upgrade/downgrade/coupon scenarios. Display a clear "You will be charged $X.XX today" preview to the user before they confirm any change. Log every event in `proration_event` for auditing. |
| **R-111.1** | **Coupon Fraud/Abuse** | High | High | Implement fraud detection (velocity, IP, device fingerprint). Enforce `max_per_customer` limit (default 1). Use `budget_cap` on campaigns to limit financial exposure. |
| **R-111.2** | **Revenue Leakage** | Medium | Medium | Auto-pause campaigns when `budget_cap` is reached. Use "Admin" role approval for any coupon &gt;50% discount. Monitor Campaign ROI in real-time. |
| **R-112.1** | **Negative Margin** | Low | Critical | Use `CEILING()` on all credit calculations. Set default `margin_multiplier` to 1.5x (33% margin). Implement P0 "Negative Margin Detection" alert to page on-call team. |
| **R-112.2** | **Vendor Price Increases** | High | High | Implement automated weekly job to scrape/check vendor pricing pages. Trigger "Vendor Rate Change &gt;10%" alert, forcing admin review to adjust multipliers. |
| **R-119.1** | **Privilege Escalation** | Low | Critical | Enforce strict hierarchy (`Admin` cannot assign `Super Admin`). Enforce MFA for role changes. `PermissionService` logic must be heavily unit-tested. Log *every* role/permission change to immutable `RoleChangeLog`. |
| **R-119.2** | **Super Admin Compromise** | Low | Critical | Enforce Hardware MFA (YubiKey) for Super Admins. Enforce `IPWhitelist` for all Super Admin access. Implement strict approval workflows for any action *by* a Super Admin. |
| **R-121.1** | **API Harmonization Delays** | Medium | High | Frontend (Workstream 5) and Backend (Workstreams 1-4) teams must have daily stand-ups. Use mock API data (`msw`) in frontend development to proceed in parallel, but gate UI merging on backend API completion. |
| **R-121.2** | **UI Inconsistency** | Low | Medium | Enforce a single shared component library. All PRs for the admin UI must be reviewed by the frontend lead for adherence to the Deep Navy theme and 1-indexed pagination standard. |

## 13. Document Change Log

| **Version** | **Date** | **Author** | **Changes** |
| --- | --- | --- | --- |
| 1.0 | 2025-11-10 | Gemini | **Final Self-Contained Plan**. Merged all content from source plans 108, 109, 110, 111, 112, 115, 119, 120, and 121. This document supersedes all previous versions and individual plans. |